# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## 项目概述

**项目名称：** 上海药品信息管理与查询平台（SH-Drug-Mgmt）

**架构类型：** B/S架构Web平台

**核心目标：** 连接药店、供应商、监管部门、物流公司，实现药品信息集中管理、流通追溯、库存监控、B2B模拟交易与监管可视化

## 技术栈

### 前端
- **框架：** Vue 3 + Vite
- **要求：** 兼容 Chrome 90+/Firefox 88+/Edge 90+
- **语言：** 简体中文

### 后端
- **框架：** Flask
- **数据库：** SQLite
- **认证：** JWT
- **权限控制：** RBAC

### 外部服务
- **地图服务：** 高德地图API
- **实时通信：** WebSocket（位置推送）

## 系统架构

### 核心模块
1. **账户信息管理子系统** - 用户注册、企业认证、权限管理
2. **企业库存管理子系统** - 药品库存登记、更新、预警
3. **B2B供求平台子系统** - 供应信息发布、查看、模拟下单
4. **流通监管子系统** - 流通数据上报、全生命周期追溯
5. **监管分析子系统** - 监管看板、合规分析报告
6. **智能调度子系统** - 药品定位、路径规划、实时监控

### 数据库设计
**15张核心表：**
- `users` - 用户表（username唯一，包含手机号、邮箱等联系信息）
- `tenants` - 租户表（企业信息）
- `enterprise_certifications` - 企业认证表（存储认证申请和审核状态）
- `drugs` - 药品信息表
- `inventory_items` - 库存项表（quantity≥0）
- `circulation_records` - 流通记录表
- `supply_info` - 供应信息表
- `orders` - 订单表（头）
- `order_items` - 订单明细
- `logistics_records` - 物流记录表
- `roles` - 角色表
- `permissions` - 权限表
- `user_roles` - 用户角色关联表
- `role_permissions` - 角色权限关联表
- `operation_logs` - 操作日志表
- `password_reset_tokens` - 密码重置令牌表

## 用户角色与权限

### 用户类型
1. **未认证用户（UNAUTHENTICATED）** - 新注册用户默认角色，仅可查看公开信息、提交企业认证申请、修改个人资料
2. **药店用户（PHARMACY）** - 库存管理、下单采购、查看供应商信息
3. **供应商用户（SUPPLIER）** - 库存管理、发布供应信息、处理订单
4. **监管用户（REGULATOR）** - 数据监控、合规分析、查看所有数据
5. **物流用户（LOGISTICS）** - 运输状态上报、路径规划、位置更新
6. **系统管理员（ADMIN）** - 用户管理、权限配置、企业认证审核、系统维护

### 关键约束
- **租户数据隔离：** 所有数据访问必须基于租户ID校验
- **密码策略：** 最少8位，必须包含字母和数字
- **权限控制：** 基于RBAC的细粒度权限管理

## 核心功能需求

### 账户信息管理子系统

#### UC-A-001: 用户注册
**必填字段：**
- 用户名（唯一性校验）
- 密码（最少8位，必须包含字母和数字）
- 手机号或邮箱（用于验证码和找回密码）

**注册流程：**
1. 前端异步检查用户名唯一性
2. 密码强度实时提示
3. 注册成功后默认角色为"未认证用户"
4. 自动跳转到登录页面或企业认证页面

#### UC-A-002: 企业信息认证
**认证要求（按角色）：**
- **药店用户**：《药品经营许可证》、《营业执照》
- **供应商用户**：《药品生产许可证》或《药品经营许可证》(批发)、《营业执照》
- **物流用户**：《道路运输经营许可证》、《营业执照》
- **监管用户**：无需企业认证，由管理员直接创建

**认证流程：**
1. 用户提交认证申请，状态变为"审核中"
2. 管理员在3个工作日内完成审核
3. 审核通过后获得对应角色权限
4. 认证失败可重新提交（最多3次）
**文件要求：**
- 支持JPG、PNG、PDF格式
- 单文件大小不超过5MB
- 建议分辨率300dpi以上

#### UC-A-003: 密码管理
**密码修改：**
- 需验证旧密码
- 新密码符合安全策略
- 修改后需重新登录

**密码找回：**
- 通过注册手机号或邮箱接收验证码
- 验证码有效期10分钟
- 重置密码后立即生效

#### UC-A-004: 用户信息管理（管理员）
**用户列表显示：**
- 用户名、真实姓名、所属企业、用户角色、账号状态
- 最后登录时间、注册时间

**管理功能：**
- 按角色、状态、企业筛选
- 禁用/启用用户账号
- 查看用户详细信息
- 分配和调整角色权限
**操作记录：**
- 所有管理操作记录审计日志
- 包含操作人、时间、操作内容

#### UC-A-005: 企业认证审核（管理员）
**审核标准：**
- 共通标准：《营业执照》真实有效，企业信息一致
- 角色专属标准：根据角色要求检查相应许可证

**审核流程：**
1. 按角色动态显示审核标准清单
2. 逐项核对资质文件
3. 标准化驳回原因选择
4. 审核结果站内信通知
**审核时限：**
- 服务目标：3个工作日内完成
- 超时自动提醒管理员

#### UC-A-006: 角色权限管理（管理员）
**预定义角色：**
- UNAUTHENTICATED、PHARMACY、SUPPLIER、REGULATOR、LOGISTICS、ADMIN

**权限变更：**
- 用户重新登录后生效
- 支持角色分配和权限调整
- 无权限访问返回明确错误提示
**权限验证：**
- 前端菜单权限控制
- 后端API权限校验
- 租户数据严格隔离

### 企业库存管理子系统

#### UC-S-001: 库存登记与更新
**核心字段：**
- 药品ID（从系统主数据选择）
- 生产批号（手动输入）
- 生产日期
- 有效期限
- 库存数量（不可为负数）

**权限控制：**
- 基于tenant_id的数据隔离
- 前后端双重权限验证
- 仅允许操作本企业库存
**操作记录：**
- 所有库存变更记录operation_logs
- 保证操作可追溯

#### UC-S-002: 库存预警
**默认阈值：**
- 库存数量 < 10件
- 药品有效期 < 30天

**预警机制：**
- 每日定时任务扫描（凌晨执行）
- 库存列表页面高亮显示预警项
- 首页提供"预警中心"汇总
**预警准确率：** 100%

### B2B供求平台子系统

#### UC-B-001: 发布供应信息
**必填字段：**
- 药品ID（从列表选择）
- 可供数量
- 有效期限
- 备注信息（可选）

**供应信息状态：**
- **ACTIVE**（活跃/上架）：对所有药店用户可见，可被下单
- **INACTIVE**（非活跃/下架）：用户主动下架，不再可见
- **EXPIRED**（已过期）：超过有效期，系统自动置为过期
**修改规则：**
- 无PENDING订单：可修改所有字段，可下架
- 有PENDING订单：仅可修改备注，不可修改核心字段或下架

#### UC-B-002: 查看供应信息
**显示规则：**
- 仅显示ACTIVE状态且有效期大于当前时间的供应信息
- 列表包含药品信息和供应商企业名称

**排序与筛选：**
- 默认按发布时间倒序排列
- 支持按药品通用名或商品名关键词搜索
- 分页加载，每页20条记录
**刷新机制：**
- 每5分钟自动刷新
- 支持手动刷新按钮
- 下单时再次验证信息有效性

#### UC-B-003: 模拟下单
**订单状态定义：**
- **PENDING**（待确认）：药店已下单，等待供应商确认
- **CONFIRMED**（已确认）：供应商确认接受订单
- **SHIPPED**（已发货）：供应商已发货，等待物流接收
- **IN_TRANSIT**（运输中）：物流已接收，正在运输途中
- **DELIVERED**（已送达）：药品已送达目的地
- **COMPLETED**（已完成）：药店已确认收到药品，订单完成
- **CANCELLED_BY_PHARMACY**（药店取消）：药店在待确认期间取消
- **CANCELLED_BY_SUPPLIER**（供应商取消）：供应商拒绝接受订单
- **EXPIRED_CANCELLED**（超时取消）：供应商24小时内未响应
**订单流程：**
1. 药店下单 → 状态PENDING，供应商**立即**收到系统通知
2. 供应商24小时内响应 → 确认（CONFIRMED）或拒绝（CANCELLED_BY_SUPPLIER）
3. 超时未响应 → 系统自动取消（EXPIRED_CANCELLED）
4. 供应商确认订单 → 点击"发货"按钮，状态变为SHIPPED
5. 物流接收货物 → 状态变为IN_TRANSIT，开始运输
6. 药品送达目的地 → 状态变为DELIVERED
7. 药店收到药品 → 点击"确认收货"，状态变为COMPLETED

**订单信息字段：**
- **订单基本信息**：订单ID、创建时间、状态
- **关联信息**：供应信息ID、药品详情、供应商企业信息
- **采购信息**：订购数量、期望交付时间（可选）
- **双方信息**：药店企业信息、联系人、备注（可修改）
- **物流信息**：物流公司、运单号、发货时间、预计到达时间
- **收货信息**：实际收货时间、收货人签字（图片上传）
- **位置信息**：发货地址、收货地址（从企业信息自动带出）
**订单修改规则：**
- 订单生成后，除"备注"字段外，其他信息均不可修改
- CONFIRMED状态后，药店不可单方面取消

#### UC-B-004: 订单管理
**状态流转规则：**
- PENDING → CONFIRMED（供应商确认接受订单）
- PENDING → CANCELLED_BY_SUPPLIER（供应商拒绝订单）
- PENDING → CANCELLED_BY_PHARMACY（药店主动取消）
- PENDING → EXPIRED_CANCELLED（24小时超时自动取消）
- CONFIRMED → SHIPPED（供应商点击"发货"）
- SHIPPED → IN_TRANSIT（物流接收货物，开始运输）
- IN_TRANSIT → DELIVERED（药品送达目的地）
- DELIVERED → COMPLETED（药店确认收货）
**最终状态：**
- COMPLETED（已完成）
- CANCELLED_BY_PHARMACY（药店取消）
- CANCELLED_BY_SUPPLIER（供应商取消）
- EXPIRED_CANCELLED（超时取消）

**操作权限：**
- 药店：PENDING状态时可取消订单，DELIVERED状态时可确认收货
- 供应商：PENDING状态时可确认/拒绝订单，CONFIRMED状态时可发货
- 物流：SHIPPED状态时可接收货物，IN_TRANSIT状态时可更新运输状态和位置
- CONFIRMED状态后，药店不可单方面取消
**物流触发机制：**
- **供应商手动操作**：在订单管理界面点击"发货"按钮，状态从CONFIRMED变为SHIPPED
- **物流系统集成**：物流公司上报状态，自动更新订单状态
- **收货确认**：药店用户在收到药品后点击"确认收货"，状态从DELIVERED变为COMPLETED

**审计记录：**
- 完整记录状态变更，包含操作人、时间、状态变化
- 物流操作记录物流公司、运单号、发货时间等信息
- 下单数量超过可用数量时，系统阻止下单并提示"库存不足"

### 流通监管子系统

#### UC-R-001: 流通数据上报
**任务描述：**
流通数据上报是物流用户的核心任务，负责实时更新订单的物流状态信息。

**上报权限：**
- 物流公司用户（主要责任人）
- 需登录验证角色权限
**流通记录与订单关联：**
- 流通记录ID即订单的运单号
- 流通记录关联订单的供应商、药店（购买方）信息
- 运输状态与订单状态同步更新

**上报信息：**
- 必填：运单号（流通记录ID）、运输状态、时间戳
- 可选：当前位置（GPS坐标或文字地址）、备注信息
**运输状态（与订单状态同步）：**
- SHIPPED（已发货）：供应商发货后生成运单号，状态为SHIPPED，同时订单状态更新为SHIPPED
- IN_TRANSIT（在途）：运单状态变为IN_TRANSIT后，订单状态也同步变为IN_TRANSIT
- DELIVERED（已送达）：运单状态变为DELIVERED后，订单状态也更新为DELIVERED

**状态同步规则：**
- 供应商发货后，生成运单号，状态从CONFIRMED变为SHIPPED
- 物流接收货物后，状态从SHIPPED变为IN_TRANSIT
- 药品送达目的地后，状态从IN_TRANSIT变为DELIVERED
- DELIVERED状态不可逆
- IN_TRANSIT状态可重复上报更新位置
**未来扩展：**
- 运输状态可获取位置信息
- 订单状态从物流公司数据库中获取位置信息

**异常处理：**
- 运单号不存在 → 返回404
- 状态非法 → 返回400
- 权限不足 → 返回403

#### UC-R-002: 药品全生命周期追溯
**查询条件：**
- 必填：药品批号
- 可选：时间范围、区域范围

**展示方式：**
- 时间轴视图：出厂→仓库→在途→药店
- 流向图可视化：直观展示流转路径
**数据来源：**
- circulation_records表（流通记录）
- logistics_records表（运输状态）
- drugs表（药品信息）

**性能要求：**
- 响应时间≤5秒
- 对关键字段建立索引优化查询
**查询结果：**
- 完整流通链条信息
- 每个状态的时间点和详情
- 若批号不存在，提示"未查询到相关流通记录"

### 监管分析子系统

#### UC-A-001: 监管看板
**核心指标：**
- 当前药品总库存量
- 在途药品数量
- 各区域流通量对比
- 异常上报数量（延迟上报、数据不一致）

**图表类型：**
- 折线图（时间序列分析）
- 柱状图（区域对比）
- 地图热点分布（地理维度）
**筛选条件：**
- 时间范围（近7天、近1月、自定义）
- 区域范围（按行政区划筛选）

**刷新机制：**
- 每5分钟自动刷新
- 支持手动刷新按钮
**性能要求：**
- 前端图表渲染时间≤3秒
- 数据与数据库实时保持一致

#### UC-A-002: 合规分析报告
**报告类型：**
- 库存合规分析：检查异常库存、缺货、过期药品
- 流通合规分析：评估运输状态异常、时效性对比
- 企业合规分析：统计企业合规率，标记违规企业

**导出格式：**
- PDF：用于正式归档和汇报
- Excel：用于二次分析和数据处理
**生成方式：**
- 手动生成（输入时间范围和区域范围）
- 浏览器内预览 + 本地下载

**性能要求：**
- 标准数据量下生成时间≤10秒
- 大数据量时提供进度提示
**权限控制：**
- 仅限监管用户下载
- 所有下载操作记录审计日志

### 智能调度子系统

#### UC-L-001: 药品定位与就近推荐
**推荐逻辑：**
- 输入：药店坐标（自动获取或手动输入）+ 搜索半径
- 输出：按距离升序排列的供应商列表

**结果显示：**
- 供应商企业名称
- 与药店的距离
- 预计配送时间
- 公开的联系方式
**技术实现：**
- 集成高德地图API
- 距离计算误差≤5%

**性能要求：**
- 响应时间≤2秒
- 返回列表至少包含企业名称和预计配送时间

#### UC-D-001: 最优配送路径规划
**输入条件：**
- 必填：起点位置（仓库坐标/地址）
- 必填：多个配送目的地（至少2个）
- 可选：各目的地时间窗口（V1.0暂不支持）

**算法与数据源：**
- 集成高德地图实时交通API
- 综合最短路径 + 实时交通速度
- Fallback：静态最短路径计算
**输出内容：**
- 最优配送顺序
- 每段预计行驶时间与里程
- 总行程时间与总距离
- 地图路线可视化展示

**性能要求：**
- 计算时间≤30秒（10个目的地以内）
- API调用超时≤5秒
**优化目标：**
- 比人工规划减少20%+总时长或里程

#### UC-L-002: 实时运输监控
**数据来源：**
- 车辆GPS设备
- 每30秒推送一次位置数据

**显示内容：**
- 实时轨迹（折线图）
- 当前车辆位置（标注点）
- 预计到达时间（ETA）
**刷新方式：**
- WebSocket推送（主要方式）
- 定时轮询（Fallback，30秒）

**性能要求：**
- 位置更新延迟≤30秒
- 地图加载时间≤3秒
**未来扩展：**
- 异常报警（延误/绕路提示）
- 历史轨迹回放功能

## 技术规范

### API设计
- **协议：** RESTful API
- **数据格式：** JSON
- **认证：** 所有非公开API需携带JWT Token
- **实时通信：** WebSocket用于位置推送

### 性能要求
- **页面加载：** ≤3秒
- **常规操作：** ≤2秒
- **并发支持：** 10用户并发
- **数据容量：** 支持5000+流通记录

### 质量属性
- **核心功能可用性：** ≥95%
- **认证机制：** JWT
- **授权机制：** RBAC
- **数据隔离：** 租户ID校验

## 开发规范

### 代码规范
- 使用RESTful API设计原则
- 所有API响应采用统一JSON格式
- 数据库操作使用事务保障一致性
- 关键字段建立索引优化查询性能

### 安全要求
- 密码加密存储
- JWT Token有效期管理
- API访问权限校验
- 租户数据严格隔离

### 错误处理
- 统一异常处理机制
- 友好的错误信息提示
- 完整的操作日志记录

## 开发环境设置

### 本地开发
1. **前端环境：**
   ```bash
   npm install
   npm run dev
   ```

2. **后端环境：**
   ```bash
   pip install -r requirements.txt
   python app.py
   ```

### 数据库
- **开发环境：** SQLite
- **初始化：** 执行数据库迁移脚本
- **测试数据：** 提供基础测试数据集

## 部署与运维

### 部署要求
- Web服务器（Nginx/Apache）
- WSGI服务器（Gunicorn/uWSGI）
- 数据库服务器（生产环境可使用PostgreSQL/MySQL）

### 监控指标
- 系统响应时间
- API调用成功率
- 数据库性能
- 用户活跃度

## 项目边界与约束

### 功能排除
- ❌ 真实在线支付功能
- ❌ 与国家药监局系统直连
- ❌ B2C功能（仅支持B2B）

### 业务约束
- 所有交易均为模拟性质
- 不可用于真实商业交易
- 监管数据仅供分析使用

## 优先级标准

### 优先级定义
- **高（High）：** 核心功能，必须实现
- **中（Medium）：** 重要功能，不影响核心流程
- **低（Low）：** 辅助功能，后续迭代

### 开发优先级
1. **第一优先级：** 账户信息管理（用户注册、企业认证、权限管理）、库存管理、B2B基础功能
2. **第二优先级：** 流通监管、数据分析
3. **第三优先级：** 智能调度、高级分析功能

## 文档与测试

### 文档要求
- API文档自动生成
- 数据库设计文档
- 用户操作手册
- 系统部署指南

### 测试要求
- 单元测试覆盖率≥80%
- 集成测试覆盖核心流程
- 性能测试验证响应时间
- 安全测试确保数据隔离