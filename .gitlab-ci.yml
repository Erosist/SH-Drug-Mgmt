# .gitlab-ci.yml
# 【最终修复版】告诉 CI/CD，我们所有的代码都在 'vue-project' 子文件夹里

stages:
  - test

test-backend:
  stage: test
  tags:
    - SH-Drug-Mgmt  # 使用你的“G盘发电机”

  # （关键！）在真正“执行”前，先 cd 进到 'vue-project' 文件夹
  before_script:
    - cd vue-project
    - echo "我现在在 `vue-project` 文件夹里，我开始安装后端..."
    - cd backend  # （现在 `cd backend` 终于能找到了！）
    - pip install -r requirements.txt
    - pip install pytest pytest-flask pytest-mock

  script:
    - echo "我*必须*回到 'vue-project' 才能运行 pytest..."
    - cd ..  # (从 backend/ 退回到 vue-project/)
    
    # --- ！！！这就是“修复 Bug”的那一行！！！ ---
    # 告诉 Python (在 PowerShell 中) "把当前目录(.)也加入到 import 搜索路径"
    - $env:PYTHONPATH = ".;$env:PYTHONPATH"
    # --- ！！！修复完毕！！！ ---
    
    - pytest backend/tests/  # (现在，pytest 终于能找到 'backend' 模块了！)

test-frontend:
  stage: test
  tags:
    - SH-Drug-Mgmt  # 使用你的“G盘发电机”

  # （关键！）在真正“执行”前，也先 cd 进到 'vue-project' 文件夹
  before_script:
    - cd vue-project
    - echo "我现在在 `vue-project` 文件夹里，我开始安装前端..."
    - npm install # （它现在终于能找到*正确*的 'package.json' 了！）

  script:
    - echo "我正在 `vue-project` 里运行前端测试..."
    - npm run test