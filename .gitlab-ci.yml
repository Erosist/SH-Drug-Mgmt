stages:
  - test

# 设置变量避免编码问题
variables:
  GIT_CLEAN_FLAGS: none
  PYTHONIOENCODING: utf-8

test-backend:
  stage: test
  tags:
    - SH-Drug-Mgmt
  script:
    - echo "=== Backend Test Started ==="
    - cd backend
    - echo "Installing dependencies..."
    - python -m pip install --quiet -r requirements.txt
    - python -m pip install --quiet pytest pytest-flask pytest-mock pytest-cov
    - echo "Initializing database..."
    - export FLASK_ENV=testing
    - python -c "from app import create_app, db; app = create_app('testing'); ctx = app.app_context(); ctx.push(); db.create_all(); print('Database initialized successfully'); ctx.pop()"
    - echo "Running tests..."
    - export PYTHONPATH=".:$PYTHONPATH"
    - python -m pytest tests/ -v --tb=short --cov=. --cov-report=xml --cov-report=html
    - echo "=== Backend Test Completed ==="
  artifacts:
    paths:
      - backend/htmlcov/
      - backend/coverage.xml
    expire_in: 1 week
  coverage: '/TOTAL.*\s+(\d+%)$/'

test-frontend:
  stage: test
  tags:
    - SH-Drug-Mgmt
  script:
    - echo "=== Frontend Test Started ==="
    - cd frontend
    - echo "Installing dependencies..."
    - npm install --silent
    - echo "Running linting..."
    - npm run lint
    - echo "Running tests..."
    - npm run test:run
    - echo "=== Frontend Test Completed ==="
  allow_failure: true

# 代码质量检查
code-quality:
  stage: test
  tags:
    - SH-Drug-Mgmt
  script:
    - echo "=== Code Quality Check Started ==="
    - echo "Checking backend code quality..."
    - cd backend
    - python -m pip install --quiet flake8 black isort
    - python -m flake8 . --max-line-length=88 --exclude=migrations,venv,__pycache__ || echo "Flake8 warnings found"
    - python -m black --check . || echo "Code formatting issues found"
    - python -m isort --check-only . || echo "Import sorting issues found"
    - echo "=== Code Quality Check Completed ==="
  allow_failure: true