stages:
  - test

# 设置变量避免编码问题
variables:
  GIT_CLEAN_FLAGS: none
  PYTHONIOENCODING: utf-8

test-backend:
  stage: test
  tags:
    - SH-Drug-Mgmt
  script:
    - Write-Host "=== Backend Test Started ==="
    - Set-Location backend
    - Write-Host "Installing dependencies..."
    - python -m pip install --quiet -r requirements.txt
    - python -m pip install --quiet pytest pytest-flask pytest-mock pytest-cov
    - Write-Host "Initializing database..."
    - $env:FLASK_ENV = "testing"
    - python -c "from app import create_app, db; app = create_app('testing'); ctx = app.app_context(); ctx.push(); db.create_all(); print('Database initialized successfully'); ctx.pop()"
    - Write-Host "Running tests..."
    - $env:PYTHONPATH = ".;$env:PYTHONPATH"
    - python -m pytest tests/ -v --tb=short --cov=. --cov-report=xml --cov-report=html
    - Write-Host "=== Backend Test Completed ==="
  artifacts:
    reports:
      coverage: backend/coverage.xml
    paths:
      - backend/htmlcov/
    expire_in: 1 week
  coverage: '/TOTAL.*\s+(\d+%)$/'

test-frontend:
  stage: test
  tags:
    - SH-Drug-Mgmt
  script:
    - Write-Host "=== Frontend Test Started ==="
    - Set-Location frontend
    - Write-Host "Installing dependencies..."
    - npm install --silent
    - Write-Host "Running linting..."
    - npm run lint
    - Write-Host "Running tests..."
    - npm run test:run
    - Write-Host "=== Frontend Test Completed ==="
  allow_failure: true

# 代码质量检查
code-quality:
  stage: test
  tags:
    - SH-Drug-Mgmt
  script:
    - Write-Host "=== Code Quality Check Started ==="
    - Write-Host "Checking backend code quality..."
    - Set-Location backend
    - python -m pip install --quiet flake8 black isort
    - python -m flake8 . --max-line-length=88 --exclude=migrations,venv,__pycache__ || Write-Host "Flake8 warnings found"
    - python -m black --check . || Write-Host "Code formatting issues found"
    - python -m isort --check-only . || Write-Host "Import sorting issues found"
    - Write-Host "=== Code Quality Check Completed ==="
  allow_failure: true