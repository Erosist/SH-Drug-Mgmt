stages:
  - test

# 设置变量避免编码问题
variables:
  GIT_CLEAN_FLAGS: none
  PYTHONIOENCODING: utf-8

test-backend:
  stage: test
  tags:
    - SH-Drug-Mgmt
  timeout: 15m
  script:
    - echo "=== Backend Test Started ==="
    - Set-Location backend
    - echo "Installing dependencies..."
    - python -m pip install --quiet -r requirements.txt
    - python -m pip install --quiet pytest
    - echo "Running basic tests..."
    - python -m pytest tests/test_auth_simple.py -v --tb=short || true
    - echo "=== Backend Test Completed ==="
  allow_failure: true

test-frontend:
  stage: test
  tags:
    - SH-Drug-Mgmt
  timeout: 10m
  script:
    - echo "=== Frontend Test Started ==="
    - Set-Location frontend
    - echo "Checking if npm packages exist..."
    - if (Test-Path node_modules) { echo "npm packages cached" } else { npm install --silent }
    - echo "=== Frontend Test Completed ==="
  allow_failure: true

# 代码质量检查
code-quality:
  stage: test
  tags:
    - SH-Drug-Mgmt
  timeout: 10m
  script:
    - echo "=== Code Quality Check Started ==="
    - echo "Checking backend code quality..."
    - Set-Location backend
    - python -m pip install --quiet flake8 black isort
    - python -m flake8 . --max-line-length=88 --exclude=migrations,venv,__pycache__,tests || echo "Flake8 check completed"
    - echo "=== Code Quality Check Completed ==="
  allow_failure: true