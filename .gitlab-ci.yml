stages:
  - test

# è®¾ç½®å˜é‡é¿å…ç¼–ç é—®é¢˜
variables:
  GIT_CLEAN_FLAGS: none
  PYTHONIOENCODING: utf-8

test-backend:
  stage: test
  tags:
    - SH-Drug-Mgmt
  timeout: 15m
  script:
    - echo "=== Backend Test Started ==="
    - Set-Location backend
    - echo "Installing dependencies..."
    # ğŸš€ ä¿®æ”¹1ï¼šåŠ ä¸Šæ¸…åæºï¼Œå¹¶å»æ‰ --quiet (æ–¹ä¾¿çœ‹è¿›åº¦)
    - python -m pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
    - python -m pip install pytest -i https://pypi.tuna.tsinghua.edu.cn/simple
    - echo "Running basic tests..."
    # âš ï¸ æ³¨æ„ï¼š|| true è¡¨ç¤ºå³ä½¿æµ‹è¯•æŒ‚äº†ï¼Œæµæ°´çº¿ä¹Ÿæ˜¾ç¤ºæˆåŠŸã€‚å¦‚æœä½ å¸Œæœ›æµ‹è¯•å¤±è´¥æ—¶æŠ¥è­¦ï¼Œè¯·å»æ‰ || true
    - python -m pytest tests/test_auth_simple.py -v --tb=short || true
    - echo "=== Backend Test Completed ==="
  allow_failure: true

test-frontend:
  stage: test
  tags:
    - SH-Drug-Mgmt
  timeout: 10m
  script:
    - echo "=== Frontend Test Started ==="
    - Set-Location frontend
    # ğŸš€ ä¿®æ”¹2ï¼šå‰ç«¯ä¹Ÿé…ç½®å›½å†…é•œåƒåŠ é€Ÿ
    - npm config set registry https://registry.npmmirror.com
    - echo "Checking if npm packages exist..."
    # è¿™é‡Œå»æ‰äº† --silentï¼Œè®©ä½ èƒ½çœ‹åˆ°å®‰è£…è¿›åº¦
    - if (Test-Path node_modules) { echo "npm packages cached" } else { npm install }
    - echo "=== Frontend Test Completed ==="
  allow_failure: true

# ä»£ç è´¨é‡æ£€æŸ¥
code-quality:
  stage: test
  tags:
    - SH-Drug-Mgmt
  timeout: 10m
  script:
    - echo "=== Code Quality Check Started ==="
    - echo "Checking backend code quality..."
    - Set-Location backend
    # ğŸš€ ä¿®æ”¹3ï¼šå·¥å…·åŒ…å®‰è£…ä¹ŸåŠ é•œåƒæº
    - python -m pip install flake8 black isort -i https://pypi.tuna.tsinghua.edu.cn/simple
    - python -m flake8 . --max-line-length=88 --exclude=migrations,venv,__pycache__,tests || echo "Flake8 check completed"
    - echo "=== Code Quality Check Completed ==="
  allow_failure: true