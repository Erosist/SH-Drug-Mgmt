# 就近供应商推荐功能使用指南

## 功能概述

就近供应商推荐功能允许药店用户根据药品名称搜索附近有库存的供应商，并在地图上可视化显示位置和路径。

## 主要功能

### 1. 地图可视化
- **自动显示**：页面加载时自动显示地图
- **药店位置**：红色标记显示当前药店位置（我的位置）
- **所有供应商**：灰色标记显示所有有坐标的供应商
- **匹配供应商**：蓝色标记高亮显示有搜索药品库存的供应商
- **路径显示**：蓝色线条连接药店和匹配的供应商

### 2. 药品搜索
- **输入药品名称**：支持通用名或商品名模糊搜索
- **多种定位方式**：
  - 使用我的位置（需要先设置位置）
  - 输入详细地址（自动转换为坐标）
  - 直接输入经纬度坐标
- **搜索参数**：
  - 搜索半径：10km、30km、50km、100km或不限制
  - 显示数量：1-50个
  - 距离计算：直线距离或驾车距离（使用高德API）

### 3. 搜索结果
- **列表展示**：显示符合条件的供应商及其库存信息
- **地图高亮**：在地图上高亮显示匹配的供应商
- **路径显示**：显示从药店到各供应商的路径
- **详细信息**：
  - 药品信息（通用名、商品名、规格、厂家）
  - 库存数量和价格
  - 距离信息
  - 供应商联系方式

## 使用步骤

### 第一步：设置位置
1. 如果是第一次使用，点击"更新我的位置"按钮
2. 输入药店的详细地址
3. 系统自动将地址转换为经纬度坐标
4. 地图上会显示药店的红色标记

### 第二步：查看地图
- 地图会自动显示所有有坐标的供应商（灰色标记）
- 可以点击任意标记查看详细信息
- 使用地图工具进行缩放和平移

### 第三步：搜索药品
1. 在"药品名称"输入框输入药品名称，如"阿莫西林"
2. 选择搜索方式（推荐使用"使用我的位置"）
3. 设置搜索参数（半径、显示数量等）
4. 点击"搜索供应商"按钮

### 第四步：查看结果
1. **地图更新**：
   - 匹配的供应商变为蓝色标记（更大更醒目）
   - 显示从药店到各供应商的蓝色路径
   - 点击标记可查看详细信息（包括库存和价格）

2. **列表展示**：
   - 显示匹配供应商的列表
   - 包含药品信息、库存、价格、距离
   - 可以查看详情或直接联系供应商

### 第五步：查看详情或联系
- 点击"查看详情"按钮：查看供应商和药品的完整信息
- 点击"联系"按钮：获取供应商联系方式

## 图标说明

- 📍 红色大圆圈：我的位置（药店）
- ⚪ 灰色小圆圈：普通供应商（未匹配搜索条件）
- 🏭 蓝色大圆圈：匹配的供应商（有搜索的药品库存）
- 🔵 蓝色线条：药店到供应商的路径

## 后端配置要求

### 1. 数据库准备
确保数据库中有以下数据：
- 药品数据（drugs表）
- 供应商数据（tenants表，type='SUPPLIER'）
- 供应信息（supply_info表，关联药品和供应商）
- **重要**：供应商必须有经纬度坐标（longitude和latitude字段）

### 2. 为供应商添加坐标
运行脚本为供应商自动添加坐标：

```bash
cd backend
python add_supplier_coordinates.py
```

此脚本会：
- 查找所有没有坐标的活跃供应商
- 使用高德地图API根据地址进行地理编码
- 自动更新供应商的经纬度坐标

### 3. 测试功能
运行测试脚本检查数据：

```bash
cd backend
python test_nearby_drug_search.py
```

此脚本会显示：
- 可用的药品列表
- 有坐标的供应商数量
- 可搜索的药品（有库存且供应商有坐标）
- 推荐的测试药品名称

## API接口说明

### 1. 获取我的位置
```
GET /api/nearby/my-location
```
返回当前用户所属租户的位置信息

### 2. 获取所有供应商
```
GET /api/nearby/all-suppliers
```
返回所有有坐标的活跃供应商列表（用于地图初始显示）

### 3. 搜索就近供应商
```
POST /api/nearby/suppliers
Body: {
  "drug_name": "阿莫西林",
  "longitude": 116.470697,
  "latitude": 40.000565,
  "max_distance": 50000,
  "limit": 10,
  "use_api": false
}
```
根据药品名称搜索有库存的就近供应商

### 4. 更新位置
```
PUT /api/nearby/update-location
Body: {
  "address": "北京市朝阳区望京SOHO",
  "city": "北京市"
}
```
更新当前用户的位置信息

## 技术实现

### 前端
- Vue 3 Composition API
- Element Plus UI组件
- 高德地图JavaScript API
- Axios HTTP客户端

### 后端
- Flask Web框架
- SQLAlchemy ORM
- 高德地图Web服务API
- JWT身份认证

### 地图功能
- 自定义标记图标（SVG）
- 信息窗口（InfoWindow）
- 折线路径（Polyline）
- 自适应视野（setFitView）
- 标记分层（zIndex）

## 注意事项

1. **坐标数据必须完整**：供应商必须有经纬度坐标才能在地图上显示
2. **高德API Key**：确保在`config.py`中配置了有效的高德地图API Key
3. **用户权限**：只有已认证的药店用户才能使用此功能
4. **数据同步**：添加新供应商后需要为其添加坐标信息
5. **性能考虑**：供应商数量较多时，考虑分页或聚合显示

## 故障排查

### 地图不显示
- 检查高德地图脚本是否正确加载
- 查看浏览器控制台是否有错误
- 确认API Key是否有效

### 供应商不显示
- 检查供应商是否有坐标数据
- 运行`add_supplier_coordinates.py`添加坐标
- 确认供应商状态为活跃（is_active=True）

### 搜索无结果
- 确认药品名称拼写正确
- 检查是否有供应商有该药品库存
- 运行`test_nearby_drug_search.py`查看可搜索的药品
- 尝试扩大搜索半径

### 路径不显示
- 确认药店位置已设置
- 确认匹配的供应商有坐标
- 检查浏览器控制台是否有错误

## 扩展功能建议

1. **批量搜索**：支持同时搜索多个药品
2. **导航功能**：集成导航功能，直接导航到供应商
3. **收藏供应商**：允许用户收藏常用供应商
4. **历史记录**：保存搜索历史
5. **消息通知**：当附近有新供应商或价格变动时通知用户
6. **供应商评价**：允许用户评价供应商服务质量
7. **库存预警**：当药品库存不足时提醒药店

## 更新日志

### v2.0 (2025-12-03)
- ✨ 地图默认显示所有供应商
- ✨ 搜索后高亮显示匹配的供应商
- ✨ 显示药店到供应商的路径
- ✨ 改为按药品名称搜索
- ✨ 显示库存和价格信息
- 🎨 优化地图标记样式和大小
- 🎨 改进信息窗口内容

### v1.0 (2025-12-02)
- 🎉 初始版本发布
- ✨ 基本的地图显示功能
- ✨ 供应商搜索功能
- ✨ 位置管理功能
