# 上海药品信息管理平台 - 核心业务流程状态机图

## 1. 用户账户状态机

```mermaid
stateDiagram-v2
    [*] --> UNREGISTERED
    
    UNREGISTERED --> REGISTERED_UNAUTHENTICATED : 用户注册成功
    REGISTERED_UNAUTHENTICATED --> AUTHENTICATION_PENDING : 提交企业认证
    AUTHENTICATION_PENDING --> REGISTERED_AUTHENTICATED : 认证审核通过
    AUTHENTICATION_PENDING --> AUTHENTICATION_REJECTED : 认证审核驳回
    AUTHENTICATION_REJECTED --> AUTHENTICATION_PENDING : 重新提交认证(≤3次)
    
    REGISTERED_UNAUTHENTICATED --> DISABLED : 管理员禁用
    REGISTERED_AUTHENTICATED --> DISABLED : 管理员禁用
    DISABLED --> REGISTERED_UNAUTHENTICATED : 管理员启用
    DISABLED --> REGISTERED_AUTHENTICATED : 管理员启用
    
    REGISTERED_AUTHENTICATED --> PASSWORD_RESET : 忘记密码流程
    PASSWORD_RESET --> REGISTERED_AUTHENTICATED : 密码重置成功
    
    state REGISTERED_AUTHENTICATED {
        [*] --> PHARMACY
        [*] --> SUPPLIER
        [*] --> LOGISTICS
        [*] --> REGULATOR
        [*] --> ADMIN
        PHARMACY --> [*]
        SUPPLIER --> [*]
        LOGISTICS --> [*]
        REGULATOR --> [*]
        ADMIN --> [*]
    }
```

**状态说明：**
- **UNAUTHENTICATED**: 未认证用户
- **PHARMACY**: 药店用户
- **SUPPLIER**: 供应商用户
- **LOGISTICS**: 物流用户
- **REGULATOR**: 监管用户
- **DISABLED**: 已禁用

## 2. 企业认证流程状态机

```mermaid
stateDiagram-v2
    [*] --> DRAFT : 用户开始填写
    DRAFT --> SUBMITTED : 提交认证申请

    SUBMITTED --> PENDING_REVIEW : 系统接收申请
    PENDING_REVIEW --> APPROVED : 审核通过
    PENDING_REVIEW --> REJECTED : 审核不通过

    REJECTED --> SUBMITTED : 重新提交(最多3次)

    APPROVED --> ACTIVE : 激活权限

    ACTIVE --> EXPIRED : 认证过期
    EXPIRED --> SUBMITTED : 重新认证

    note right of PENDING_REVIEW : 管理员3个工作日内完成审核
    note right of REJECTED : 失败可重新提交，最多3次
```

**状态说明：**
- **DRAFT**: 用户保存申请草稿
- **SUBMITTED**: 已提交申请
- **PENDING_REVIEW**: 审核中
- **APPROVED**: 审核通过
- **REJECTED**: 审核不通过
- **ACTIVE**: 权限激活
- **EXPIRED**: 认证过期

## 3. 订单管理流程状态机

```mermaid
flowchart LR
    P(PENDING<br>待确认)
    
    P -->|供应商确认| C(CONFIRMED<br>已确认)
    P -->|供应商拒绝| CS(CANCELLED_BY_SUPPLIER<br>供应商取消)
    P -->|药店取消| CP(CANCELLED_BY_PHARMACY<br>药店取消)
    P -->|24小时超时| EC(EXPIRED_CANCELLED<br>超时取消)
    
    C -->|供应商发货| S(SHIPPED<br>已发货)
    S -->|物流接收| I(IN_TRANSIT<br>运输中)
    I -->|物流送达| D(DELIVERED<br>已送达)
    D -->|药店确认收货| CO(COMPLETED<br>已完成)
```

**状态说明：**
- **PENDING**: (待确认) - 药店已下单，等待供应商确认
- **CONFIRMED**: (已确认) - 供应商确认接受订单
- **SHIPPED**: (已发货) - 供应商已发货，等待物流接收
- **IN_TRANSIT**: (运输中) - 物流已接收，正在运输途中
- **DELIVERED**: (已送达) - 药品已送达目的地
- **COMPLETED**: (已完成) - 药店已确认收到药品，订单完成
- **CANCELLED_BY_PHARMACY**: (药店取消) - 药店在待确认期间取消
- **CANCELLED_BY_SUPPLIER**: (供应商取消) - 供应商拒绝接受订单
- **EXPIRED_CANCELLED**: (超时取消) - 供应商24小时内未响应



## 4. 供应信息状态机

```mermaid
stateDiagram-v2
    [*] --> DRAFT : 创建供应信息
    DRAFT --> ACTIVE : 发布供应信息

    ACTIVE --> INACTIVE : 供应商主动下架
    ACTIVE --> EXPIRED : 超过有效期

    INACTIVE --> ACTIVE : 重新上架

    EXPIRED --> ACTIVE : 重新发布（需重新设置有效期）

    note right of ACTIVE : 对所有药店用户可见，可被下单
    note right of INACTIVE : 不再对外显示
    note right of EXPIRED : 系统自动置为过期
```

**状态说明：**
- **DRAFT**: 供应信息的草稿
- **ACTIVE**: 活跃/上架（可被查看和下单）
- **INACTIVE**: 非活跃/下架（用户主动下架）
- **EXPIRED**: 已过期（超过有效期）

## 5. 流通记录状态机

```mermaid
stateDiagram-v2
    [*] --> SHIPPED : 发货

    SHIPPED --> IN_TRANSIT : 运输中

    IN_TRANSIT --> IN_TRANSIT : 更新位置信息
    IN_TRANSIT --> DELIVERED : 送达

    DELIVERED --> [*] : 流通完成

    note right of SHIPPED : 供应商或物流公司上报
    note right of IN_TRANSIT : 可重复上报更新位置
    note right of DELIVERED : 送达状态不可逆
```

**状态说明：**
- **SHIPPED**: 已发货
- **IN_TRANSIT**: 在途运输
- **DELIVERED**: 已送达



## 6. 库存预警状态机

```mermaid
stateDiagram-v2
    [*] --> NORMAL : 库存正常

    NORMAL --> LOW_STOCK : 库存 < 10件
    NORMAL --> EXPIRING : 有效期 < 30天

    LOW_STOCK --> NORMAL : 补货完成
    EXPIRING --> NORMAL : 更新新批次

    LOW_STOCK --> CRITICAL : 库存 = 0
    EXPIRING --> EXPIRED : 药品过期

    CRITICAL --> NORMAL : 补货完成
    EXPIRED --> NORMAL : 更新新批次

    note right of LOW_STOCK : 低库存预警
    note right of CRITICAL : 缺货预警
    note right of EXPIRING : 临期预警
    note right of EXPIRED : 过期处理
```

**状态说明：**
- **NORMAL**: 正常状态
- **LOW_STOCK**: 低库存预警
- **CRITICAL**: 缺货预警
- **EXPIRING**: 临期预警
- **EXPIRED**: 已过期

## 技术实现要点

### 数据库字段设计
```sql
-- 企业认证表
enterprise_certifications (status ENUM('SUBMITTED','PENDING_REVIEW','APPROVED','REJECTED','ACTIVE','EXPIRED'))

-- 订单表（9种完整状态）
orders (status ENUM('PENDING','CONFIRMED','SHIPPED','IN_TRANSIT','DELIVERED','COMPLETED','CANCELLED_BY_PHARMACY','CANCELLED_BY_SUPPLIER','EXPIRED_CANCELLED'))

-- 供应信息表
supply_info (status ENUM('ACTIVE','INACTIVE','EXPIRED'))

-- 流通记录表（与订单状态同步）
circulation_records (status ENUM('SHIPPED','IN_TRANSIT','DELIVERED'))

-- 用户表
users (status ENUM('ACTIVE','DISABLED'), role ENUM('UNAUTHENTICATED','PHARMACY','SUPPLIER','LOGISTICS','REGULATOR','ADMIN'))
```

### 状态转换验证
- 前端：根据当前状态控制按钮显示和操作权限
- 后端：API接口验证状态转换的合法性
- 数据库：使用ENUM约束确保状态值有效

### 操作日志记录
- 所有状态变更记录到 `operation_logs` 表
- 包含：操作人、时间、操作类型、状态变化详情
- 支持审计追踪和问题排查
